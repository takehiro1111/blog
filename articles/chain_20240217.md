---
title: "[AWS/GithubActions]ã‚¹ã‚¤ãƒƒãƒãƒ­ãƒ¼ãƒ«ã§åˆ¥ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨é€£æºã™ã‚‹æ–¹æ³•"
emoji: "ğŸ—‚"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["GithubActions","aws"]
published: true
---
![](/images/actions_s3/actions_logo.png =450x)

## æœ¬è¨˜äº‹ã‚’èª­ã¿çµ‚ã‚ã£ãŸæ™‚ã®ã‚´ãƒ¼ãƒ«
- GithubActionsã§AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰åˆ¥ã®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚¹ã‚¤ãƒƒãƒãƒ­ãƒ¼ãƒ«ã—ã¦å‡¦ç†ã‚’å®Ÿè¡Œå‡ºæ¥ã‚‹äº‹ã€‚

&nbsp;

## å‰æ
- GithubActionsã¨AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®é€£æºã«ã¤ã„ã¦ã¯å‰å›è¨˜äº‹ã§è§£èª¬ã—ã¦ã„ã¾ã™ã®ã§ã€ä»¥ä¸‹ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
æœ¬è¨˜äº‹ã§ã¯`chain`ã™ã‚‹éƒ¨åˆ†ã«çµã£ã¦è¨˜è¿°ã—ã¾ã™ã€‚

https://zenn.dev/takesaya/articles/github_actions
&nbsp;

## 1.GithubActions-AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆ(ã‚¹ã‚¤ãƒƒãƒå‰)ã®æ¨©é™è¨­å®š
### å‚ç…§ã™ã‚‹å´ã®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ä»¥ä¸‹å†…å®¹ã§IAMãƒãƒªã‚·ãƒ¼ã‚’è¨­å®šã—ã¾ã™ã€‚
### ä¿¡é ¼ãƒãƒªã‚·ãƒ¼
- ãƒ¦ãƒ¼ã‚¶ãƒ¼(èªè¨¼ã®å¯¾è±¡)ã¨ãªã‚‹Githubå´ã¸AssumeRoleã‚’è¨±å¯ã™ã‚‹ã€‚
```json:deploy-github-actions
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Federated": "arn:aws:iam::{ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID}:oidc-provider/token.actions.githubusercontent.com"
            },
            "Action": "sts:AssumeRoleWithWebIdentity",
            "Condition": {
                "StringLike": {
                    "token.actions.githubusercontent.com:sub": [
                        "repo:{çµ„ç¹”å or ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå}/{ãƒªãƒã‚¸ãƒˆãƒªå}:*",
                    ]
                }
            }
        }
    ]
}
```

### è¨±å¯ãƒãƒªã‚·ãƒ¼
- ã‚¹ã‚¤ãƒƒãƒãƒ­ãƒ¼ãƒ«ã™ã‚‹å…ˆã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨AssumeRole,Tagsessionã‚’å¯èƒ½ã«ã™ã‚‹ãƒãƒªã‚·ãƒ¼

```json:deploy-github-actions
{
	"Version": "2012-10-17",
	"Statement": [
		{
			"Action": [
				"s3:*",
				"s3-object-lambda:*"
			],
			"Effect": "Allow",
			"Resource": "*"
		},
		{
            "Sid": "chain",
			"Action": "sts:*",
			"Effect": "Allow",
			"Resource": "arn:aws:iam::{chainå…ˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆID}:role/chain_actions"
		}
	]
}
```

## 2.AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆ(ã‚¹ã‚¤ãƒƒãƒå‰)-AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆ(ã‚¹ã‚¤ãƒƒãƒå¾Œ)ã®æ¨©é™è¨­å®š
### å‚ç…§ã•ã‚Œã‚‹å´ã®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ä»¥ä¸‹å†…å®¹ã§IAMãƒãƒªã‚·ãƒ¼ã‚’è¨­å®šã—ã¾ã™ã€‚
### ä¿¡é ¼ãƒãƒªã‚·ãƒ¼
- ã‚¹ã‚¤ãƒƒãƒãƒ­ãƒ¼ãƒ«ã™ã‚‹éš›ã®æ¨©é™ã‚’è¨­å®š
æ··ä¹±ã™ã‚‹ä»£ç†å•é¡Œã‚’è§£æ¶ˆã™ã‚‹ãŸã‚ã«ä¸€æ„ã®IDã‚’`Condition`ã§è¨­å®šã™ã‚‹ã€‚

```json:chain_actions
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:iam::{ã‚¹ã‚¤ãƒƒãƒå‰ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID}:root"
            },
            "Action": "sts:AssumeRole",
            "Condition": {
                "StringEquals": {
                    "sts:ExternalId": "{ä¸€æ„ã®ID}"
                }
            }
        },
        {
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:iam::{ã‚¹ã‚¤ãƒƒãƒå‰ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID}:root"
            },
            "Action": "sts:TagSession"
        }
    ]
}
```

### è¨±å¯ãƒãƒªã‚·ãƒ¼
- å®Ÿéš›ã«GithubActionsã§å‡¦ç†ã™ã‚‹å†…å®¹ã‚’è¨­å®š
ä»Šå›ã‚‚S3ã®FullAccessæ¨©é™ã‚’ä»˜ä¸

```json:chain_actions
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "s3:*",
                "s3-object-lambda:*"
            ],
            "Resource": "*"
        }
    ]
}
```

3.GithubActionsã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®è¨˜è¼‰
- `main`ãƒ–ãƒ©ãƒ³ãƒã«pushã•ã‚ŒãŸéš›ã«ã‚¹ã‚¤ãƒƒãƒãƒ­ãƒ¼ãƒ«ã—ã¦S3ãƒã‚±ãƒƒãƒˆã®ä¸€è¦§ã‚’å–å¾—ã™ã‚‹å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã€‚
```yml:.github/workflows/aws_s3_ls.yml
name: Get to S3 Tokyo Region

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/*'
      - '.github/actions/*'
      - '**/*.tf'
  workflow_dispatch:

jobs:
  deploy:
    name: Get from S3 in Tokyo
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-northeast-1 
          role-to-assume: arn:aws:iam::{ã‚¹ã‚¤ãƒƒãƒãƒ­ãƒ¼ãƒ«å‰ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID}:role/deploy-github-actions 
          role-session-name: GitHubActions_s3_cp 

      - name: Configure other AWS Credentials via SwitchRole
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-northeast-1
          role-to-assume: arn:aws:iam::{ã‚¹ã‚¤ãƒƒãƒãƒ­ãƒ¼ãƒ«å¾Œã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID}:role/myaccount_actions
          role-external-id: "{ä¸€æ„ã®ID}" # "sts:ExternalId"ã§æŒ‡å®šã—ãŸID
          role-session-name: GitHubActions_s3_cp2
          role-chaining: true # chainã™ã‚‹è¨­å®šã‚’"true"ã§æŒ‡å®šã€‚

      - name: Get S3bucket
        id: Get
        run: |
          aws s3 ls
        shell:
          bash
```

![](/images/chain_githubactions/result.png)

## å‚ç…§
https://github.com/aws-actions/configure-aws-credentials

## å®Œ