---
title: "[Terraform/AWS]direnvã§AWS IAM IdentityCenterã®èªè¨¼æƒ…å ±ã‚’å–å¾—ã™ã‚‹æ–¹æ³•"
emoji: "ğŸ‘»"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Terraform","aws","IaC","Linux","SRE"]
published: true
---

![](/images/terraform_logo.png)

## è¨˜äº‹ã‚’æ›¸ã„ãŸçµŒç·¯
- æ¥­å‹™ä¸­ã€ãµã¨æ‰‹ãŒç©ºã„ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§READMEã‚’ç¢ºèªã—ãŸéš›ã«ã€direnvã«é–¢ã™ã‚‹è¨˜è¿°ã‚’è¦‹ã¤ã‘ãŸãŸã‚ã§ã™ã€‚
ãã‚Œã¨åŒæ™‚ã«READMEã¯éš…ã€…ã¾ã§èª­ã‚“ã§ãŠãã¹ãã ãªã¨æ”¹ã‚ã¦æ„Ÿã˜ãŸç¬é–“ã§ã—ãŸã€‚
&nbsp;

## æœ¬è¨˜äº‹ã‚’èª­ã¿çµ‚ã‚ã£ãŸæ™‚ã®ã‚´ãƒ¼ãƒ«
- direnvã‚’ä½¿ç”¨ã—ã¦AWSã®èªè¨¼æƒ…å ±(`access_key`,`secret_access_key`,`session_token`)ã‚’å–å¾—ã—ã€
å„modulleã§terraformãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å®Ÿè¡Œã§ãã‚‹äº‹ã€‚
&nbsp;

## å‰æã®ç’°å¢ƒ
- ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•ã‚„ã‚·ã‚§ãƒ«ã®ç¨®é¡ãŒå…¨ä½“çš„ã«MacOSå‘ã‘ã®èª¬æ˜ã«ãªã£ã¦ã„ã¾ã™ã€‚
- AWS `IAM Identity Center`åŠã³`Organizations`ã§ç®¡ç†ã—ã¦ã„ã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®èªè¨¼æƒ…å ±ã®å–å¾—ã«é–¢ã™ã‚‹å†…å®¹ã«ãªã£ã¦ã„ã¾ã™ã€‚
&nbsp;

## æœ¬ç·¨
#### direnvã¨ã¯ï¼Ÿ
- ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã”ã¨ã«ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦é©ç”¨å‡ºæ¥ã‚‹ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
ç•°ãªã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚„ä½œæ¥­ç’°å¢ƒã§ç‰¹å®šã®ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã€
direnvã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã€ãã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ãŸã¨ãã«è‡ªå‹•çš„ã«ç’°å¢ƒå¤‰æ•°ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

:::message
è£œè¶³1:æ‰‹å‹•ã®å ´åˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«éƒ½åº¦ã‚³ãƒ”ãƒšã—ã¦ä¸€æ™‚çš„ãªèªè¨¼æƒ…å ±ã‚’ç’°å¢ƒå¤‰æ•°ã«åŸ‹ã‚è¾¼ã‚€ã€‚
:::

![](/images/direnv/sso_console.png)

![](/images/direnv/secret.png)

#### ãƒ¡ãƒªãƒƒãƒˆ
- ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã”ã¨ã«å›ºæœ‰ã®ç’°å¢ƒå¤‰æ•°ã‚’å‹•çš„ã«ä½¿ç”¨ã§ãã‚‹ãŸã‚ã€æ‰‹å‹•ã§ã®èªè¨¼æƒ…å ±ã®åŸ‹ã‚è¾¼ã¿ç­‰ã®æ‰‹é–“ãŒçœã‘ã‚‹ã€‚
- å¤šæ•°ã®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’`Identity Center(æ—§SSO)`/`Organizations`ã§ç®¡ç†ã—ã¦ã„ã‚‹å ´åˆã«æ„å›³ã—ãªã„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®èªè¨¼æƒ…å ±ã‚’èª¤ã£ã¦ä½¿ç”¨ã™ã‚‹äº‹ã‚’é˜²ã’ã‚‹ã€‚
(`Terraform`,`CLI`,`SDK`ç­‰ã®AWS APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã§åˆ¶å¾¡ã™ã‚‹éš›ã¯éå¸¸ã«åŠ©ã‹ã‚Šã¾ã™ã€‚)

#### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```zsh:~
brew install direnv
```

#### è¨­å®š
##### 1. ã‚·ã‚§ãƒ«ã«hookã‚’è¨­å®šã™ã‚‹

```zsh:~/.zshrc
export EDITOR=vi #ä½¿ç”¨ã™ã‚‹ã‚¨ãƒ‡ã‚£ã‚¿ã‚’ç’°å¢ƒå¤‰æ•°ã§è¨­å®šã€‚
eval "$(direnv hook zsh)" # direnvã®ãƒ•ãƒƒã‚¯ã‚’ã‚·ã‚§ãƒ«ã«è¨­å®šã—ã¦ã€direnvã®è‡ªå‹•èª­ã¿è¾¼ã¿ã‚’æœ‰åŠ¹åŒ–ã€‚
```
```zsh:~
source /.zshrc
```

```zsh:~/.zshrc
export EDITOR=vi
eval "$(direnv hook zsh)"
```
```zsh:~
source /.zshrc
```
&nbsp;

##### 2. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰AWSã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®è¨­å®š

```zsh:~
vi .aws/config
```

```zsh:~/.aws/config
[profile xx_AdministratorAccess]
region = {ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒªãƒ¼ã‚¸ãƒ§ãƒ³}
output = json
sso_start_url = https://{IAM Identity Centerã®è¨­å®šå€¤}awsapps.com/start
sso_region ={IAM Identity Centerã®è¨­å®šãƒªãƒ¼ã‚¸ãƒ§ãƒ³ }
sso_account_id = {AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆID}
sso_role_name = {PermissionSetã®name}
```
&nbsp;

##### 3. direnvã§ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨ã—ãŸã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®è¨­å®š
```zsh:~/github/terraform/project_a
vi .envrc
```
 
```zsh:~/github/terraform/project_a/.envrc
export AWS_PROFILE="xx_AdministratorAccess"
```
- å®Ÿè¡Œã™ã‚‹äº‹ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼å´ã‹ã‚‰ã‚·ã‚§ãƒ«ã«å¯¾ã—ã¦æ˜ç¤ºçš„ã«ã“ã®.envrcã‚’ä¿¡é ¼ã™ã‚‹ã“ã¨ã‚’æŒ‡ç¤ºã€‚
```zsh:~/github/terraform
direnv allow 
```

- ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦è¨­å®šã•ã‚Œã¦ã„ã‚‹SSOã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä½¿ç”¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã‚’è¡Œã†ã€‚

```zsh:~/github/terraform/project_a
aws sso login --profile $AWS_PROFILE 
```

:::message
è£œè¶³2:aws sso login`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸéš›ã«ãƒ–ãƒ©ã‚¦ã‚¶ãƒ™ãƒ¼ã‚¹ã§å‹•çš„ã«æ‰¿èªã®ç¢ºèªãŒã‚ã‚‹ã€‚
:::

![](/images/direnv/sso_login_gui.png)

:::message
è£œè¶³3:ãƒªãƒã‚¸ãƒˆãƒªç›´ä¸‹ã«è¤‡æ•°ã®Terraformãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ç’°å¢ƒãŒå­˜åœ¨ã™ã‚‹éš›ã«ãƒ¡ã‚¤ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ä»¥ä¸‹ã®ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨.envrcã‚’è¨±å¯å‡ºæ¥ã‚‹ã€‚
     æ¥­å‹™é–‹å§‹æ™‚ç­‰ã®ç’°å¢ƒå¤‰æ•°ã«åŸ‹ã‚è¾¼ã‚“ã§ã„ã‚‹ä¸€æ™‚çš„ãªèªè¨¼æƒ…å ±ã®æœŸé™ãŒåˆ‡ã‚ŒãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å®Ÿè¡Œã™ã‚‹ã€‚
:::

```zsh:~/github/terraform/allow_envrc.sh
#!/bin/zsh
PROJECTS=($(find . -type f -name ".envrc"))
MAIN_DIR=$(pwd)

for project in "${PROJECTS[@]}" ; do
  # .envrcãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
  PROJECT_DIR=$(dirname "$project")

  # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¦direnv allowã‚’å®Ÿè¡Œã—ã€å…ƒã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«æˆ»ã‚‹
  pushd "${MAIN_DIR}/${PROJECT_DIR}" > /dev/null
  direnv allow
  popd > /dev/null
done
echo "run allowed .envrc !!"
```
![](/images/direnv/allow_envrc2.png)
&nbsp;

##### 4.Terraformã§AWSã®èªè¨¼æƒ…å ±ã‚’ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦å–å¾—ã§ãã¦ã„ã‚‹ã‹ç¢ºèªã€‚
- direnvãŒæ©Ÿèƒ½ã—ã¦ã„ã‚Œã°ã€æ‰‹å‹•ã§ç’°å¢ƒå¤‰æ•°ã«åŸ‹ã‚è¾¼ã¾ãªãã¦ã‚‚æ›¸ãã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã§ãã‚‹ã€‚

```zsh:~/github/terraform/project_a
terraform init
```
![](/images/direnv/terraform_init.png)

:::message
è£œè¶³4:èªè¨¼æƒ…å ±ã‚’å–å¾—å‡ºæ¥ã¦ã„ãªã„å ´åˆã¯` Error: No valid credential sources found`ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã€‚
:::

![](/images/direnv/no_valid.png)


#### 5.Terraformã‚³ãƒ¼ãƒ‰ã§ã®`profile`ã®è¨­å®š
- terraformãƒ–ãƒ­ãƒƒã‚¯ã®ã‚¹ãƒ†ãƒ¼ãƒˆã¨Providerãƒ–ãƒ­ãƒƒã‚¯ã«`profile`ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚å€¤ã¯ç’°å¢ƒå¤‰æ•°ã§è¨­å®šã—ã¦ã„ã‚‹profileåã§ã™ã€‚
- è©¦è¡ŒéŒ¯èª¤ã®æœ«ã®å¯¾å¿œã®ãŸã‚ã€ã‚ˆã‚Šé©åˆ‡ãªæ–¹æ³•ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
```hcl:_config.tf

terraform {
  required_version = "1.9.8"

  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "5.74.0"
    }
  }

  backend "s3" {
    bucket  = "tfstate-685339645368"
    key     = "state/state_prod"
    region  = "ap-northeast-1"
    profile = "{.envrcã§è¨­å®šã—ãŸç’°å¢ƒå¤‰æ•°ã®å€¤}" // ã“ã“
  }
}

provider "aws" {
  region  = "ap-northeast-1"
  profile = "{.envrcã§è¨­å®šã—ãŸç’°å¢ƒå¤‰æ•°ã®å€¤}" // ã“ã“

  default_tags {
    tags = {
      Repository = local.repo
      Directory  = local.dir
    }
  }
}
```
